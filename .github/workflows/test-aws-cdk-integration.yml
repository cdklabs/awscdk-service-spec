# ~~ Generated by projen. To modify, edit .projenrc.js and run "npx projen".

name: test-aws-cdk-integration
on:
  workflow_dispatch: {}
  pull_request: {}
jobs:
  test-with-new-codegen:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CI: "1"
    steps:
      - name: Checkout awscdk-service-spec
        uses: actions/checkout@v3
        with:
          path: awscdk-service-spec
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          lfs: true
      - name: Build awscdk-service-spec
        run: |-
          yarn install --frozen-lockfile
          yarn compile
          yarn workspace @aws-cdk/service-spec-build run build:db
        working-directory: awscdk-service-spec
      - name: Checkout aws/aws-cdk
        uses: actions/checkout@v3
        with:
          path: aws-cdk
          repository: aws/aws-cdk
      - name: Register drop-in @aws-cdk/cfn2ts replacement
        run: yarn link
        working-directory: awscdk-service-spec/packages/@aws-cdk/cfn2ts
      - name: Link drop-in @aws-cdk/cfn2ts replacement
        run: yarn link "@aws-cdk/cfn2ts"
        working-directory: aws-cdk
      - name: Setup aws/aws-cdk
        run: yarn install
        working-directory: aws-cdk
      - name: "Fix: aws-cdk attempts to compile awscdk-service-spec code"
        run: "npx tsc --showConfig | jq '.compilerOptions = .compilerOptions + {\"skipLibCheck\": true}' > tmp && mv tmp tsconfig.json"
        working-directory: aws-cdk/packages/aws-cdk
      - name: Build aws/aws-cdk
        run: npx lerna run build --no-bail --concurrency=2 --scope aws-cdk-lib --include-dependencies
        working-directory: aws-cdk
